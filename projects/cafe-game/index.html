<head>
	<title>Burrow's cafe game</title>
	<style>
#game-canvas {
	width:1024px;
	height:576px;
	background-color:#efefef;
	image-rendering: -moz-crisp-edges;
	image-rendering: -webkit-crisp-edges;
	image-rendering: pixelated;
	background-image:url("./img/background.png");
	background-size:contain;
}

.center {
	margin:auto;
}

p { 
	user-select: none;
}
	</style>

</head>
<body onload="init()">
	
	<div hidden>
	<form>
		<h2>Ingredients</h2>
		<input type="checkbox" id="flour_box" value="flour">
		<label for="flour_box">Flour</label><br>
		<input type="checkbox" id="sugar_box" value="sugar">
		<label for="sugar_box">Sugar</label><br>
		<input type="checkbox" id="water_box" value="water">
		<label for="water_box">Water</label><br>
		<input type="checkbox" id="dough_box" value="dough">
		<label for="dough_box">Dough</label><br>
		<br>
		<h2>Where to put?</h2>
		<input type="radio" id="combine_radio" value="combine">
		<label for="combine_radio">(Combine)</label><br>
		<input type="radio" id="pot_radio" value="pot">
		<label for="pot_radio">Pot</label><br>
		<input type="radio" id="pan_radio" value="pan">
		<label for="pan_radio">Pan</label><br>
		<input type="radio" id="oven_radio" value="oven">
		<label for="oven_radio">Oven</label>

		<input type="button" onclick="process()" value="Submit">
	</form>
	
	<p id="chosenIngredients">Output</p>
	<p id="finalFoodResult">Final Food</p>
	</div>
	
	<p id="mouseCoords">Click canvas for mouse coords</p>
	<p hidden><b id="mouseX"></b>,<b id="mouseY"></b></p>
	<p id="mouseDown"></p>
	<p id="lastLoose">Drop an object to see its deets bro</p>
	<div class="center">
		<canvas width="512" height="288" id="game-canvas" ></canvas>
	</div>
	
<script>
	/*
	{
		"name":"",
		"ingredients":[""], 
		"actions":"",
		"type":"ingredient",
		"further-actions":{
			"cutter":""
		}
	}
	
	
	
	
	*/
	
//

var scrn = {
	"width":512,
	"height":288
};

var selectedItem = -1;
var counter = {
	"minY":140,
	"maxY":218
};

//image global vars	
const imgRoot = "./img/";
const canvas = document.getElementById('game-canvas'); 
const context = canvas.getContext('2d');
context.imageSmoothingEnabled= false;
var background = new Image();

//recipes
var recipes = {
	"recipes":[
	{
		"name":"dough",
		"ingredients":["flour","water"], 
		"actions":"mixer",
		"type":"ingredient",
		"further-actions":{
			"pot":"bagel",
			"oven":"bread",
			"pan":"fried_dough"
		}
	},
	{
		"name":"bread",
		"ingredients":["dough"], 
		"actions":"oven",
		"type":"ingredient",
		"further-actions":{
			"cutter":"sliced_bread"
		}
	},
	{
		"name":"fried_dough",
		"ingredients":["dough"], 
		"actions":"pan",
		"type":"dish",
		"further-actions":{
			
		}
	},
	{
		"name":"bagel",
		"ingredients":["dough"], 
		"actions":"oven",
		"type":"ingredient",
		"further-actions":{
		}
	}
]};


var inventory = {
	"inventory":[
	{
		"name":"flour",
		"unlimited":true,
		"qty":0
	},
	{
		"name":"water",
		"unlimited":true,
		"qty":0
	},
	{
		"name":"egg",
		"unlimited":true,
		"qty":0
	},
	{
		"name":"sugar",
		"unlimited":true,
		"qty":0
	}
]};

var appliances = {
	"appliances":[
	{
		"name":"pan",
		"tlx":497,
		"tly":300,
		"brx":916,
		"bry":427
	},
	{
		"name":"mixer",
		"tlx":403,
		"tly":57,
		"brx":428,
		"bry":127
	}
]};

function arrayCompare(_arr1, _arr2) {
    if (
      !Array.isArray(_arr1)
      || !Array.isArray(_arr2)
      || _arr1.length !== _arr2.length
      ) {
        return false;
      }
    
    // .concat() to not mutate arguments
    const arr1 = _arr1.concat().sort();
    const arr2 = _arr2.concat().sort();
    
    for (let i = 0; i < arr1.length; i++) {
        if (arr1[i] !== arr2[i]) {
            return false;
         }
    }
    
    return true;
}

function process() {
	//var declaration
	let selectedIngredients = [];
	let rawInputs = document.getElementsByTagName("input");
	let selectedRadio = "";
	//let baseFood = "";
	let finalFood = "";
	
	//iterate through inputs on form
	for (let i = 0; i < rawInputs.length; i++) {
		if (rawInputs[i].type == "checkbox") { //get ingredients
			if (rawInputs[i].checked) {
				
				selectedIngredients.push(rawInputs[i].value);
			}
			
		} else if (rawInputs[i].type == "radio") { //get action
			if (rawInputs[i].checked) {
				selectedRadio = rawInputs[i].value;
			}
		}
	}
	console.log("selectedIngredients: " + selectedIngredients);
	console.log("how many recipes: " + recipes.recipes.length);
	//get finalFood from chosen ingredients
	
	for (let i = 0; i < recipes.recipes.length;i++) {
		//console.log("recipes[" + i + "].ingredients: " + recipes.recipes[i].ingredients);
		if (arrayCompare(recipes.recipes[i].ingredients,selectedIngredients)) { //are ingredients the same?
			if (recipes.recipes[i].actions == selectedRadio) { //is action correct?
				finalFood = recipes.recipes[i].name;
				break;
			}
		}
	}
	if (finalFood == "") {
		finalFood = "complete shit";
	}
	
	//prints results to HTML
	document.getElementById("compilation_check").innerHTML = "Compiled successfully";
	document.getElementById("chosenIngredients").innerHTML = "Ingredients picked: " + selectedIngredients;
	document.getElementById("finalFoodResult").innerHTML = "You made: <b>" + finalFood + "</b> in the " + selectedRadio;
	
}

var looseItems = [];
var maxVel = 3;
var gravityMod = 1.2;

function makeLooseItem(name,x,y) {
	let temp = {
		"name":name,
		"x":x,
		"y":y,
		"yv":2,
		"targetY":-1
	};
	looseItems.push(temp);
	console.log("new loose item '" + temp.name + "' at " + temp.x + "," + temp.y);
}

function processLooseItems() {
	var toDelete = [];
	for (let i = 0; i < looseItems.length; i++) {
		if (looseItems[i].targetY == -1) { //first frame?
			if (looseItems[i].y < counter.maxY) { //on or above counter?
				if (looseItems[i].y < counter.minY) { //above counter
					console.log("above counter");
					looseItems[i].targetY = Math.floor(Math.random() * (counter.maxY - counter.minY)) + counter.minY;
				} else { //on counter
					console.log("on counter");
					looseItems[i].targetY = looseItems[i].y;
					
				}
			} else { //below counter
				console.log("below counter");
				looseItems[i].targetY = 300;
			}
		} else { //processing post-drop
			if (looseItems[i].y < looseItems[i].targetY && looseItems[i].y < scrn.height) {
				//console.log("y < targetY; " + looseItems[i].y + " < " + looseItems[i].targetY);
				looseItems[i].y++;//looseItems[i].yv;
			}
			
			if (looseItems[i].yv < maxVel) { //still accelerating
				console.log("yv is under maxVel");

				looseItems[i].yv = looseItems[i].yv * gravityMod;
			} else {
				looseItems[i].yv = maxVel;
			}
			
		}

		
		/*
		if (looseItems[i].targetY == -1) { //if destination not set
			if (looseItems[i].y > counter.maxY) { //if below counter, fall off screen
				looseItems[i].targetY = 500;
			}
			if (looseItems[i].y < counter.minY) { //if above counter, fall onto counter
				looseItems[i].targetY = Math.floor(Math.random() * (counter.maxY - counter.minY)) + counter.minY;
			}
			
		}
		else {
			if (looseItems[i].yv < maxVel) {
				looseItems[i].y += looseItems[i].yv;
				looseItems[i].yv *= gravityMod;
			} else {
				looseItems[i].yv = maxVel;
			}
		}
		
		if (looseItems[i].y > scrn.height) { //deletes offscreen items
			toDelete.push(i);
		}
		*/
	}
	for (let i = 0; i < toDelete.length; i++) {
		//delete looseItems[i];
	}
	if (looseItems.length > 0) {
		let lastLoose = looseItems[looseItems.length - 1];
		document.getElementById("lastLoose").innerHTML = "position:(" + lastLoose.x + "," + lastLoose.y + ")<br>targetY:" + lastLoose.targetY + "<br>yv:" + lastLoose.yv;
	}
}

var water = new Image();
water.src = imgRoot + "water.png"; 

var flour = new Image();
flour.src = imgRoot + "flour.png"; 

function drawIcon(foodName,x,y,width,height) {
	if (foodName == "water") {
		context.drawImage(water,x,y);
	}
	if (foodName == "flour") {
		context.drawImage(flour,x,y);
	}

	const img = new Image();        
	img.src = imgRoot + foodName + ".png";        
	img.onload = () => {
		if (arguments.length == 3) {
			context.drawImage(img, x, y); 
		} else if (arguments.length == 5) {
			context.drawImage(img, x, y,width,height); 
		}
	};
}

function drawLooseItems() {
	//let mouseX = parseInt(document.getElementById("mouseX").innerHTML);
	//let mouseY = document.getElementById("mouseY").innerHTML.toString();
	for (let i = 0;i < looseItems.length; i++) {
		drawIcon(looseItems[i].name,looseItems[i].x,looseItems[i].y);
	}
}

function drawStatusBar() {
	let tlx = 120;
	let tly = 242;
	let spacing = 6;
	let hotbarWidth = 7;
	
	if (mouseJustDown) {
		console.log("mouse at " + mouseX + "," + mouseY);
	}
	for (let i = 0; i < hotbarWidth; i++) {
		//console.log("at " + i + ", mouse needs to be between (" + (tlx + i * (32 + spacing)) + "," + tly + ") and (" + (tlx + 32 + i * (32 + spacing)) + "," + (tly + 32) + ")");
		
		
		
		if (i > inventory.inventory.length - 1) {
			break;
		}
		let hover = false;
		if (tlx + i * (32 + spacing) < mouseX && mouseX < tlx + 32 + i * (32 + spacing)) {
			//console.log("x range is correct when i = " + i);
			if (tly < mouseY && mouseY < tly + 32) {
				hover = true;
				if (mouseJustDown) {
					selectedItem = i;
					console.log("selectedItem: " + inventory.inventory[i].name);
				}
				
			}
		}
			
		if (hover) {
			drawIcon(inventory.inventory[i].name,tlx + i * (32 + spacing),tly,34,34);
		} else {
			drawIcon(inventory.inventory[i].name,tlx + i * (32 + spacing),tly);
		}
		
		if (selectedItem == i && mouseDown) {
			drawIcon(inventory.inventory[i].name,mouseX,mouseY);
		}
		
		
	}
	mouseJustDown = false;
}

function drawAll() {
	//context.drawImage(background,0,0,256,144);     
	drawStatusBar();
	drawLooseItems();
	//drawIcon("egg",0,0);
	//drawIcon("egg",32,32,32,32,32,32);
}

function init() {

}

function processes() {
	if (mouseJustUp && selectedItem != -1) {
		makeLooseItem(inventory.inventory[selectedItem].name,mouseX,mouseY);
		mouseJustUp = false;
		console.log("# of loose items: " + looseItems.length);
	}
	if (!mouseDown) {
		selectedItem = -1;
	}
	
	processLooseItems();
}

var mainloop = setInterval(function() {
	context.clearRect(0, 0, canvas.width, canvas.height);
	processes();
	drawAll();
	if (1 == 0) {
		clearInterval(mainloop);
	}
},30);

</script>
	
<script src="mouse.js"></script>

</body>
